/*! jQuery strPx v1.0 2013/01/31
* http://www.moon4dreams.com
* Copyright (c) 2013 USE MIT License*/
//仅用于浏览器默认Serif字体 字体大小限制在8px~20px

(function($){
  //var map50 = [0, 16, 18, 28, 28, 44, 33, 10, 17, 17, 19, 29, 14, 17, 14, 14, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 14, 14, 29, 29, 29, 28, 51, 33, 33, 36, 36, 33, 31, 39, 36, 14, 25, 33, 28, 41, 36, 39, 33, 39, 36, 33, 31, 36, 33, 50, 33, 33, 31, 14, 14, 14, 22, 28, 17, 28, 28, 25, 28, 28, 14, 28, 28, 12, 10, 25, 12, 40, 28, 28, 28, 28, 17, 25, 14, 28, 25, 35, 24, 25, 25, 17, 12, 17, 29];
	//var map30 = [0, 9, 11, 17, 17, 27, 20, 6, 10, 10, 12, 18, 8, 10, 8, 8, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 8, 8, 18, 18, 18, 17, 30, 19, 20, 22, 22, 20, 18, 23, 22, 7, 15, 20, 17, 25, 22, 23, 20, 23, 22, 20, 19, 22, 19, 30, 19, 19, 18, 8, 8, 8, 14, 17, 10, 16, 17, 15, 17, 16, 8, 17, 17, 7, 7, 15, 7, 25, 17, 16, 17, 17, 10, 15, 8, 17, 15, 21, 14, 15, 15, 10, 8, 10, 18];
	var map20 = [0, 6, 7, 11, 11, 18, 13, 4, 7, 7, 8, 12, 6, 7, 6, 6, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 6, 6, 12, 12, 12, 11, 20, 13, 13, 14, 14, 13, 12, 16, 13, 6, 10, 13, 11, 17, 13, 16, 13, 16, 14, 13, 12, 13, 13, 19, 13, 14, 12, 6, 6, 6, 8, 11, 7, 11, 11, 10, 11, 11, 6, 11, 10, 4, 4, 10, 4, 16, 10, 11, 11, 11, 7, 10, 6, 10, 9, 15, 9, 10, 9, 7, 6, 7, 12];
	var map19 = [0, 6, 7, 11, 11, 17, 13, 4, 6, 6, 7, 11, 5, 6, 5, 5, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 5, 5, 11, 11, 11, 11, 19, 13, 13, 14, 14, 13, 12, 15, 13, 6, 10, 13, 11, 15, 13, 15, 13, 15, 14, 13, 12, 13, 13, 19, 13, 12, 12, 5, 5, 5, 7, 11, 6, 10, 11, 10, 11, 11, 6, 11, 10, 4, 4, 9, 4, 16, 10, 11, 11, 11, 6, 10, 5, 10, 9, 13, 9, 9, 9, 6, 6, 6, 11];
	var map18 = [0, 6, 6, 10, 10, 16, 12, 3, 6, 6, 7, 11, 5, 6, 5, 5, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 5, 5, 11, 11, 11, 10, 18, 11, 12, 13, 13, 12, 11, 14, 13, 4, 9, 12, 10, 15, 13, 14, 12, 14, 13, 12, 12, 13, 11, 17, 11, 12, 11, 5, 5, 5, 7, 10, 6, 10, 10, 9, 10, 10, 5, 10, 10, 4, 4, 9, 4, 14, 10, 10, 10, 10, 6, 9, 5, 10, 9, 13, 8, 9, 8, 6, 6, 6, 11];
	var map17 = [0, 5, 6, 9, 9, 15, 11, 3, 6, 6, 7, 10, 5, 6, 5, 5, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 5, 5, 10, 10, 10, 9, 17, 11, 11, 12, 12, 11, 10, 12, 11, 5, 9, 11, 9, 13, 11, 12, 11, 12, 11, 11, 9, 11, 11, 17, 11, 11, 9, 5, 5, 5, 7, 9, 6, 9, 9, 9, 9, 9, 5, 9, 9, 4, 3, 8, 3, 13, 9, 9, 9, 9, 6, 8, 4, 9, 7, 11, 7, 9, 8, 6, 5, 6, 10];
	//16px;
	var map =   [0, 5, 6, 9, 9, 14, 11, 3, 5, 5, 6, 9, 4, 5, 4, 4, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 4, 4, 9, 9, 9, 9, 16, 11, 11, 12, 12, 11, 10, 12, 11, 3, 8, 11, 9, 13, 11, 12, 11, 12, 11, 11, 9, 11, 11, 15, 11, 9, 9, 4, 4, 4, 7, 9, 5, 9, 9, 8, 9, 9, 4, 9, 8, 4, 3, 8, 3, 13, 8, 9, 9, 9, 5, 8, 4, 8, 7, 11, 7, 7, 7, 5, 3, 5, 9];
	//15px;
	var map15 = [0, 5, 5, 8, 8, 13, 10, 3, 5, 5, 6, 9, 4, 5, 4, 4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 4, 4, 9, 9, 9, 8, 15, 9, 10, 11, 11, 10, 9, 11, 10, 3, 7, 10, 8, 11, 10, 12, 10, 12, 11, 10, 9, 10, 9, 15, 9, 9, 8, 4, 4, 4, 5, 8, 5, 8, 8, 8, 8, 8, 4, 8, 8, 3, 3, 7, 3, 13, 8, 8, 8, 8, 5, 8, 4, 8, 7, 11, 7, 7, 8, 5, 3, 5, 9];
	var map14 = [0, 5, 5, 8, 8, 12, 9, 3, 5, 5, 5, 8, 4, 5, 4, 4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 4, 4, 8, 8, 8, 8, 14, 9, 9, 10, 10, 9, 9, 11, 9, 3, 6, 9, 8, 11, 9, 11, 9, 11, 10, 9, 9, 9, 9, 13, 8, 9, 8, 4, 4, 4, 5, 8, 5, 8, 8, 7, 8, 8, 4, 8, 8, 3, 3, 7, 3, 11, 8, 8, 8, 8, 5, 7, 4, 8, 7, 9, 6, 7, 6, 5, 3, 5, 8];
	var map13 = [0, 3, 5, 7, 7, 12, 9, 2, 4, 4, 5, 8, 4, 4, 4, 4, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 4, 4, 8, 8, 8, 7, 13, 9, 9, 9, 9, 9, 8, 10, 9, 3, 6, 9, 7, 11, 9, 10, 9, 10, 9, 9, 7, 9, 9, 13, 7, 9, 7, 4, 4, 4, 5, 7, 4, 7, 7, 7, 7, 7, 3, 7, 7, 3, 3, 7, 3, 11, 7, 7, 7, 7, 4, 7, 4, 7, 5, 9, 7, 7, 7, 4, 3, 4, 8];
	var map12 = [0, 3, 4, 7, 7, 11, 8, 2, 4, 4, 5, 7, 3, 4, 3, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3, 7, 7, 7, 7, 12, 7, 8, 9, 9, 8, 7, 9, 9, 3, 6, 8, 7, 9, 9, 9, 8, 9, 9, 8, 7, 9, 7, 11, 7, 7, 7, 3, 3, 3, 5, 7, 4, 7, 7, 6, 7, 7, 3, 7, 7, 3, 3, 6, 3, 11, 7, 7, 7, 7, 4, 7, 3, 7, 5, 9, 5, 5, 5, 4, 3, 4, 7];
	//var map11 = [0, 3, 4, 7, 7, 11, 8, 2, 4, 4, 5, 7, 3, 4, 3, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3, 7, 7, 7, 7, 12, 7, 8, 9, 9, 8, 7, 9, 9, 3, 6, 8, 7, 9, 9, 9, 8, 9, 9, 8, 7, 9, 7, 11, 7, 7, 7, 3, 3, 3, 5, 7, 4, 7, 7, 6, 7, 7, 3, 7, 7, 3, 3, 6, 3, 11, 7, 7, 7, 7, 4, 7, 3, 7, 5, 9, 5, 5, 5, 4, 3, 4, 7];
	//var map10 = [0, 3, 4, 7, 7, 11, 8, 2, 4, 4, 5, 7, 3, 4, 3, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3, 7, 7, 7, 7, 12, 7, 8, 9, 9, 8, 7, 9, 9, 3, 6, 8, 7, 9, 9, 9, 8, 9, 9, 8, 7, 9, 7, 11, 7, 7, 7, 3, 3, 3, 5, 7, 4, 7, 7, 6, 7, 7, 3, 7, 7, 3, 3, 6, 3, 11, 7, 7, 7, 7, 4, 7, 3, 7, 5, 9, 5, 5, 5, 4, 3, 4, 7];
	//var map9  = [0, 3, 4, 7, 7, 11, 8, 2, 4, 4, 5, 7, 3, 4, 3, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3, 7, 7, 7, 7, 12, 7, 8, 9, 9, 8, 7, 9, 9, 3, 6, 8, 7, 9, 9, 9, 8, 9, 9, 8, 7, 9, 7, 11, 7, 7, 7, 3, 3, 3, 5, 7, 4, 7, 7, 6, 7, 7, 3, 7, 7, 3, 3, 6, 3, 11, 7, 7, 7, 7, 4, 7, 3, 7, 5, 9, 5, 5, 5, 4, 3, 4, 7];
	//var map8  = [0, 3, 4, 7, 7, 11, 8, 2, 4, 4, 5, 7, 3, 4, 3, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3, 7, 7, 7, 7, 12, 7, 8, 9, 9, 8, 7, 9, 9, 3, 6, 8, 7, 9, 9, 9, 8, 9, 9, 8, 7, 9, 7, 11, 7, 7, 7, 3, 3, 3, 5, 7, 4, 7, 7, 6, 7, 7, 3, 7, 7, 3, 3, 6, 3, 11, 7, 7, 7, 7, 4, 7, 3, 7, 5, 9, 5, 5, 5, 4, 3, 4, 7];
/**
 * 将字符串按像素显示
 * @param {Object} lineStr 需要测试的字符串
 * @param {Object} ellipsis 像素值限制 true or number
 */
$.fn.strpx = function(lineStr,ellipsis){
	if(!lineStr){
		if(ellipsis) {
			return lineStr;
		}else{
			return 0;
		}
	}
	
	var pxlimit = 0;
			
	if(ellipsis === true){			
		//! 必须为元素指定宽度
		pxlimit = this.innerWidth();			
	}else if($.isNumeric(ellipsis) && ellipsis < pxlimit){
		pxlimit = ellipsis;
	}
	//map 对应的字体大小	
	var fontsize = 16;
	try{
		fontsize = parseInt(this.css('font-size').slice(0,-2));
	}catch(e){
		//$.error(e);
	}
	//字符串副本
	var tmpStr = new String(lineStr);
	//像素长度
	var pxlen = 0;
	//字符串副本中的字符
	var ct;
	
	for(var t = 0,lt = tmpStr.length; t < lt;t++){
		ct = tmpStr.charAt(t);
		//中文等			
		if(escape(ct).length > 4){
			pxlen += fontsize;
		//ascii 32-126
		}else if(ct.charCodeAt(0)>31 && ct.charCodeAt(0)<127){
			pxlen += map[ct.charCodeAt(0)-32];
		}
		//需要按像素截取字符串时，进行如下处理，先找到不计算空格比需要的像素值大的位置，然后加上递减尝试,直到找到合适的子字符串
		if(pxlimit >0 && pxlen*fontsize/16 > pxlimit){
			try{									
				var d = 1;	
				do{
					currentSub = tmpStr.substring(0,t-d);
					pxlen += getSpaceLength(currentSub,fontsize);
					d += 1;					
				}while(pxlen*fontsize/16 > pxlimit);					
				return currentSub;
			}catch(e){
				return '';
			}				
		}
	}
	
	if(ellipsis){
		return lineStr;
	}else{
		pxlen += getSpaceLength(tmpStr,fontsize);
		return parseInt(pxlen*fontsize/16);
	}
};

//获取空格显示的像素值
function getSpaceLength(str,fontsize){
		var reg = /\S(\x20)+\S/gi;
		var substrings = str.match(reg)	;
		if(substrings){			
			//50px  14px;
			//20px  6px;
			//19px  5px;
			//18px  5px;
			//17px  5px;
			//16px  4px;
			//15px  4px;
			//14px  4px;
			//13px  4px;
			//12px  3px;
			return substrings.length * parseInt(4 * fontsize/16);
		}else return 0;			
	}
	
})(jQuery);
